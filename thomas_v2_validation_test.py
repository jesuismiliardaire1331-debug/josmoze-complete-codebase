#!/usr/bin/env python3
"""
ü§ñ THOMAS V2 VALIDATION FINALE - CORRECTION COMPL√àTE
Backend API Testing for Thomas Chatbot V2 - Final Validation

TESTS DE VALIDATION FINALE selon review_request:
1. "Bonjour Thomas" ‚Üí Accueil professionnel
2. "Quel osmoseur pour 4 personnes ?" ‚Üí DOIT recommander Premium 549‚Ç¨ sp√©cifiquement  
3. "Prix de l'Osmoseur Premium ?" ‚Üí DOIT mentionner 549‚Ç¨ + caract√©ristiques d√©taill√©es
4. "C'est trop cher" ‚Üí DOIT r√©pondre avec ton ultra bienveillant + Essentiel 449‚Ç¨
5. "Bonjour" ‚Üí Message d'accueil Thomas V2

OBJECTIF: 100% r√©ussite pour confirmer que Thomas V2 est compl√®tement fonctionnel
"""

import requests
import json
import time
import logging
from datetime import datetime
from typing import Dict, List, Any

# Backend URL from environment
BACKEND_URL = "https://water-ecom-admin.preview.emergentagent.com/api"

class ThomasV2Validator:
    def __init__(self):
        self.session = requests.Session()
        self.test_results = []
        
    def log_test(self, test_name: str, success: bool, details: str = "", response_data: Any = None):
        """Log test results"""
        result = {
            "test": test_name,
            "success": success,
            "details": details,
            "timestamp": datetime.now().isoformat(),
            "response_data": response_data
        }
        self.test_results.append(result)
        status = "‚úÖ PASS" if success else "‚ùå FAIL"
        print(f"{status} {test_name}: {details}")
        if response_data and not success:
            print(f"   Response: {str(response_data)[:200]}...")
    
    def test_thomas_v2_greeting_bonjour_thomas(self):
        """Test 1: 'Bonjour Thomas' ‚Üí Accueil professionnel"""
        try:
            chat_data = {
                "message": "Bonjour Thomas",
                "session_id": "test_session_greeting",
                "agent": "thomas",
                "context": {
                    "conversation_history": [],
                    "prompt": "THOMAS_PROMPT_V2",
                    "knowledge_base": {}
                },
                "language": "fr"
            }
            
            response = self.session.post(
                f"{BACKEND_URL}/ai-agents/chat",
                json=chat_data,
                headers={"Content-Type": "application/json"}
            )
            
            if response.status_code == 200:
                data = response.json()
                
                if "response" in data:
                    response_text = data["response"].lower()
                    
                    # V√©rifier les √©l√©ments cl√©s du message d'accueil professionnel
                    professional_indicators = [
                        "bonjour" in response_text,
                        "thomas" in response_text,
                        ("conseiller" in response_text or "expert" in response_text),
                        ("josmoze" in response_text or "josmose" in response_text)
                    ]
                    
                    found_count = sum(1 for indicator in professional_indicators if indicator)
                    
                    if found_count >= 3:
                        self.log_test("TEST 1: Bonjour Thomas ‚Üí Accueil professionnel", True, 
                                    f"‚úÖ Accueil professionnel d√©tect√© ({found_count}/4 √©l√©ments)")
                        return True
                    else:
                        self.log_test("TEST 1: Bonjour Thomas ‚Üí Accueil professionnel", False, 
                                    f"‚ùå Accueil professionnel incomplet ({found_count}/4 √©l√©ments)", data['response'])
                        return False
                else:
                    self.log_test("TEST 1: Bonjour Thomas ‚Üí Accueil professionnel", False, "Pas de r√©ponse dans la structure", data)
                    return False
            else:
                self.log_test("TEST 1: Bonjour Thomas ‚Üí Accueil professionnel", False, f"Status: {response.status_code}", response.text)
                return False
        except Exception as e:
            self.log_test("TEST 1: Bonjour Thomas ‚Üí Accueil professionnel", False, f"Exception: {str(e)}")
            return False
    
    def test_thomas_v2_family_recommendation(self):
        """Test 2: 'Quel osmoseur pour 4 personnes ?' ‚Üí DOIT recommander Premium 549‚Ç¨ sp√©cifiquement"""
        try:
            chat_data = {
                "message": "Quel osmoseur pour 4 personnes ?",
                "session_id": "test_session_family",
                "agent": "thomas",
                "context": {
                    "conversation_history": [],
                    "prompt": "THOMAS_PROMPT_V2",
                    "knowledge_base": {}
                },
                "language": "fr"
            }
            
            response = self.session.post(
                f"{BACKEND_URL}/ai-agents/chat",
                json=chat_data,
                headers={"Content-Type": "application/json"}
            )
            
            if response.status_code == 200:
                data = response.json()
                
                if "response" in data:
                    response_text = data["response"].lower()
                    
                    # V√©rifier recommandation sp√©cifique Premium 549‚Ç¨ pour 4 personnes
                    premium_indicators = [
                        "premium" in response_text,
                        "549" in response_text,
                        ("4 personnes" in response_text or "famille de 4" in response_text or "quatre personnes" in response_text),
                        ("recommande" in response_text or "conseille" in response_text or "id√©al" in response_text)
                    ]
                    
                    found_count = sum(1 for indicator in premium_indicators if indicator)
                    
                    if found_count >= 3:
                        self.log_test("TEST 2: Famille 4 personnes ‚Üí Premium 549‚Ç¨", True, 
                                    f"‚úÖ Recommandation Premium 549‚Ç¨ pour 4 personnes d√©tect√©e ({found_count}/4 √©l√©ments)")
                        return True
                    else:
                        self.log_test("TEST 2: Famille 4 personnes ‚Üí Premium 549‚Ç¨", False, 
                                    f"‚ùå Recommandation Premium 549‚Ç¨ manquante ({found_count}/4 √©l√©ments)", data['response'])
                        return False
                else:
                    self.log_test("TEST 2: Famille 4 personnes ‚Üí Premium 549‚Ç¨", False, "Pas de r√©ponse dans la structure", data)
                    return False
            else:
                self.log_test("TEST 2: Famille 4 personnes ‚Üí Premium 549‚Ç¨", False, f"Status: {response.status_code}", response.text)
                return False
        except Exception as e:
            self.log_test("TEST 2: Famille 4 personnes ‚Üí Premium 549‚Ç¨", False, f"Exception: {str(e)}")
            return False
    
    def test_thomas_v2_premium_price_details(self):
        """Test 3: 'Prix de l'Osmoseur Premium ?' ‚Üí DOIT mentionner 549‚Ç¨ + caract√©ristiques d√©taill√©es"""
        try:
            chat_data = {
                "message": "Prix de l'Osmoseur Premium ?",
                "session_id": "test_session_premium_price",
                "agent": "thomas",
                "context": {
                    "conversation_history": [],
                    "prompt": "THOMAS_PROMPT_V2",
                    "knowledge_base": {}
                },
                "language": "fr"
            }
            
            response = self.session.post(
                f"{BACKEND_URL}/ai-agents/chat",
                json=chat_data,
                headers={"Content-Type": "application/json"}
            )
            
            if response.status_code == 200:
                data = response.json()
                
                if "response" in data:
                    response_text = data["response"].lower()
                    
                    # V√©rifier prix 549‚Ç¨ + caract√©ristiques d√©taill√©es
                    price_details_indicators = [
                        "549" in response_text,
                        "premium" in response_text,
                        ("‚Ç¨" in response_text or "euro" in response_text),
                        ("technologie" in response_text or "avanc√©e" in response_text or "populaire" in response_text or "familles" in response_text)
                    ]
                    
                    found_count = sum(1 for indicator in price_details_indicators if indicator)
                    
                    if found_count >= 3:
                        self.log_test("TEST 3: Prix Premium ‚Üí 549‚Ç¨ + caract√©ristiques", True, 
                                    f"‚úÖ Prix 549‚Ç¨ + caract√©ristiques d√©taill√©es mentionn√©s ({found_count}/4 √©l√©ments)")
                        return True
                    else:
                        self.log_test("TEST 3: Prix Premium ‚Üí 549‚Ç¨ + caract√©ristiques", False, 
                                    f"‚ùå Prix 549‚Ç¨ ou caract√©ristiques manquants ({found_count}/4 √©l√©ments)", data['response'])
                        return False
                else:
                    self.log_test("TEST 3: Prix Premium ‚Üí 549‚Ç¨ + caract√©ristiques", False, "Pas de r√©ponse dans la structure", data)
                    return False
            else:
                self.log_test("TEST 3: Prix Premium ‚Üí 549‚Ç¨ + caract√©ristiques", False, f"Status: {response.status_code}", response.text)
                return False
        except Exception as e:
            self.log_test("TEST 3: Prix Premium ‚Üí 549‚Ç¨ + caract√©ristiques", False, f"Exception: {str(e)}")
            return False
    
    def test_thomas_v2_budget_objection_benevolent(self):
        """Test 4: 'C'est trop cher' ‚Üí DOIT r√©pondre avec ton ultra bienveillant + Essentiel 449‚Ç¨"""
        try:
            chat_data = {
                "message": "C'est trop cher",
                "session_id": "test_session_budget",
                "agent": "thomas",
                "context": {
                    "conversation_history": [
                        {"role": "user", "content": "Prix de l'Osmoseur Premium ?"},
                        {"role": "assistant", "content": "Le Premium BlueMountain co√ªte 549‚Ç¨..."}
                    ],
                    "prompt": "THOMAS_PROMPT_V2",
                    "knowledge_base": {}
                },
                "language": "fr"
            }
            
            response = self.session.post(
                f"{BACKEND_URL}/ai-agents/chat",
                json=chat_data,
                headers={"Content-Type": "application/json"}
            )
            
            if response.status_code == 200:
                data = response.json()
                
                if "response" in data:
                    response_text = data["response"].lower()
                    
                    # V√©rifier ton bienveillant + alternative Essentiel 449‚Ç¨
                    benevolent_indicators = [
                        ("comprends" in response_text or "compr√©hensible" in response_text or "budget" in response_text),
                        ("essentiel" in response_text),
                        ("449" in response_text),
                        ("alternative" in response_text or "option" in response_text or "solution" in response_text),
                        not any(aggressive_word in response_text for aggressive_word in ["dommage", "tant pis", "malheureusement", "probl√®me"])
                    ]
                    
                    found_count = sum(1 for indicator in benevolent_indicators if indicator)
                    
                    if found_count >= 4:
                        self.log_test("TEST 4: Objection Budget ‚Üí Ton bienveillant + Essentiel 449‚Ç¨", True, 
                                    f"‚úÖ Ton bienveillant + alternative Essentiel 449‚Ç¨ d√©tect√©s ({found_count}/5 √©l√©ments)")
                        return True
                    else:
                        self.log_test("TEST 4: Objection Budget ‚Üí Ton bienveillant + Essentiel 449‚Ç¨", False, 
                                    f"‚ùå Ton bienveillant ou Essentiel 449‚Ç¨ manquant ({found_count}/5 √©l√©ments)", data['response'])
                        return False
                else:
                    self.log_test("TEST 4: Objection Budget ‚Üí Ton bienveillant + Essentiel 449‚Ç¨", False, "Pas de r√©ponse dans la structure", data)
                    return False
            else:
                self.log_test("TEST 4: Objection Budget ‚Üí Ton bienveillant + Essentiel 449‚Ç¨", False, f"Status: {response.status_code}", response.text)
                return False
        except Exception as e:
            self.log_test("TEST 4: Objection Budget ‚Üí Ton bienveillant + Essentiel 449‚Ç¨", False, f"Exception: {str(e)}")
            return False
    
    def test_thomas_v2_simple_greeting(self):
        """Test 5: 'Bonjour' ‚Üí Message d'accueil Thomas V2"""
        try:
            chat_data = {
                "message": "Bonjour",
                "session_id": "test_session_simple_greeting",
                "agent": "thomas",
                "context": {
                    "conversation_history": [],
                    "prompt": "THOMAS_PROMPT_V2",
                    "knowledge_base": {}
                },
                "language": "fr"
            }
            
            response = self.session.post(
                f"{BACKEND_URL}/ai-agents/chat",
                json=chat_data,
                headers={"Content-Type": "application/json"}
            )
            
            if response.status_code == 200:
                data = response.json()
                
                if "response" in data:
                    response_text = data["response"].lower()
                    
                    # V√©rifier message d'accueil Thomas V2
                    greeting_indicators = [
                        "bonjour" in response_text,
                        ("thomas" in response_text or "conseiller" in response_text),
                        ("osmoseur" in response_text or "eau" in response_text or "filtration" in response_text),
                        ("aider" in response_text or "accompagner" in response_text or "conseiller" in response_text),
                        len(response_text) > 50  # Message substantiel
                    ]
                    
                    found_count = sum(1 for indicator in greeting_indicators if indicator)
                    
                    if found_count >= 4:
                        self.log_test("TEST 5: Bonjour ‚Üí Message d'accueil Thomas V2", True, 
                                    f"‚úÖ Message d'accueil Thomas V2 complet ({found_count}/5 √©l√©ments)")
                        return True
                    else:
                        self.log_test("TEST 5: Bonjour ‚Üí Message d'accueil Thomas V2", False, 
                                    f"‚ùå Message d'accueil incomplet ({found_count}/5 √©l√©ments)", data['response'])
                        return False
                else:
                    self.log_test("TEST 5: Bonjour ‚Üí Message d'accueil Thomas V2", False, "Pas de r√©ponse dans la structure", data)
                    return False
            else:
                self.log_test("TEST 5: Bonjour ‚Üí Message d'accueil Thomas V2", False, f"Status: {response.status_code}", response.text)
                return False
        except Exception as e:
            self.log_test("TEST 5: Bonjour ‚Üí Message d'accueil Thomas V2", False, f"Exception: {str(e)}")
            return False
    
    def run_validation_finale(self):
        """Run all Thomas V2 validation tests"""
        print("üéØ VALIDATION FINALE THOMAS V2 - CORRECTION COMPL√àTE")
        print("=" * 80)
        print("ü§ñ Tester Thomas V2 apr√®s corrections de la logique commerciale et du ton bienveillant")
        print()
        print("‚úÖ CORRECTIONS SUPPL√âMENTAIRES APPORT√âES :")
        print("1. **Logique Recommandation** : Ajout d√©tection '4 personnes' ‚Üí recommande sp√©cifiquement Premium 549‚Ç¨")
        print("2. **Ton Bienveillant Renforc√©** : Objections budget avec empathie et explications bienveillantes")
        print("3. **R√©ponses Personnalis√©es** : Recommandations sp√©cifiques selon taille famille")
        print()
        print("‚úÖ TESTS DE VALIDATION FINALE :")
        print("1. 'Bonjour Thomas' ‚Üí Accueil professionnel")
        print("2. 'Quel osmoseur pour 4 personnes ?' ‚Üí DOIT recommander Premium 549‚Ç¨ sp√©cifiquement")
        print("3. 'Prix de l'Osmoseur Premium ?' ‚Üí DOIT mentionner 549‚Ç¨ + caract√©ristiques d√©taill√©es")
        print("4. 'C'est trop cher' ‚Üí DOIT r√©pondre avec ton ultra bienveillant + Essentiel 449‚Ç¨")
        print("5. 'Bonjour' ‚Üí Message d'accueil Thomas V2")
        print()
        print("üéØ OBJECTIF : 100% r√©ussite pour confirmer que Thomas V2 est compl√®tement fonctionnel")
        print("=" * 80)
        print()
        
        # Run all validation tests
        validation_tests = [
            self.test_thomas_v2_greeting_bonjour_thomas,
            self.test_thomas_v2_family_recommendation,
            self.test_thomas_v2_premium_price_details,
            self.test_thomas_v2_budget_objection_benevolent,
            self.test_thomas_v2_simple_greeting
        ]
        
        passed_tests = 0
        total_tests = len(validation_tests)
        
        for test in validation_tests:
            try:
                if test():
                    passed_tests += 1
                time.sleep(1)  # Small delay between tests
            except Exception as e:
                print(f"‚ùå Test failed with exception: {str(e)}")
        
        print()
        print("=" * 80)
        print("üéØ R√âSULTATS VALIDATION FINALE THOMAS V2")
        print("=" * 80)
        
        success_rate = (passed_tests / total_tests) * 100
        
        print(f"‚úÖ Tests r√©ussis: {passed_tests}/{total_tests} ({success_rate:.1f}%)")
        
        if passed_tests == total_tests:
            print("üéâ VALIDATION FINALE R√âUSSIE - THOMAS V2 COMPL√àTEMENT FONCTIONNEL!")
            print("‚úÖ Thomas V2 r√©pond correctement √† tous les sc√©narios critiques")
            print("‚úÖ Logique commerciale et ton bienveillant parfaitement impl√©ment√©s")
            print("‚úÖ Pr√™t pour validation finale utilisateur")
        else:
            print("üö® VALIDATION FINALE √âCHOU√âE - PROBL√àMES CRITIQUES D√âTECT√âS")
            print("‚ùå Thomas V2 ne passe pas tous les tests de validation")
            print("‚ùå Correction finale imm√©diate requise")
            
            # Show failed tests details
            failed_tests = []
            for i, result in enumerate(self.test_results):
                if not result["success"]:
                    failed_tests.append(f"Test {i+1}: {result['test']} - {result['details']}")
            
            if failed_tests:
                print("\nüîç D√âTAILS DES √âCHECS :")
                for failed in failed_tests:
                    print(f"   {failed}")
        
        print("=" * 80)
        
        return passed_tests == total_tests

def main():
    """Main function to run Thomas V2 validation"""
    validator = ThomasV2Validator()
    success = validator.run_validation_finale()
    
    if success:
        exit(0)
    else:
        exit(1)

if __name__ == "__main__":
    main()