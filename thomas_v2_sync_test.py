#!/usr/bin/env python3
"""
ü§ñ VALIDATION THOMAS V2 SYNCHRONISATION BACKEND-FRONTEND
=======================================================
Test complet de synchronisation Thomas V2 apr√®s mise √† jour backend thomas_chatbot_fixed.py

TESTS CRITIQUES DE SYNCHRONISATION :
1. **Nouveau Prompt V2** : V√©rifier utilisation des response_templates
2. **Prix Corrects** : 449‚Ç¨ Essentiel, 549‚Ç¨ Premium, 899‚Ç¨ Prestige, 39.90‚Ç¨ Filtre Douche
3. **Ton Bienveillant** : Pas de pression agressive, accompagnement
4. **Accueil Professionnel** : Message d'accueil selon template V2
5. **Objections Budget** : R√©ponse "budget serr√©" avec solution Essentiel

MESSAGES DE TEST :
- "Bonjour" ‚Üí Template accueil V2
- "Quels sont vos prix ?" ‚Üí Affichage prix corrects (449‚Ç¨, 549‚Ç¨, 899‚Ç¨, 39.90‚Ç¨)
- "C'est trop cher" ‚Üí R√©ponse bienveillante budget + Essentiel 449‚Ç¨
- "Parlez-moi du Premium" ‚Üí Info Premium 549‚Ç¨ avec thomas_pitch
- "Filtre douche" ‚Üí Info 39.90‚Ç¨ correct

üéØ OBJECTIF : 80%+ de r√©ussite pour valider synchronisation
"""

import requests
import json
import time
import logging
from datetime import datetime
from typing import Dict, List, Any

# Backend URL from environment
BACKEND_URL = "https://water-ecom-admin.preview.emergentagent.com/api"

class ThomasV2SyncTester:
    def __init__(self):
        self.session = requests.Session()
        self.test_results = []
        self.success_count = 0
        self.total_tests = 0
        
    def log_test(self, test_name: str, success: bool, details: str = "", response_data: Any = None):
        """Log test results"""
        result = {
            "test": test_name,
            "success": success,
            "details": details,
            "timestamp": datetime.now().isoformat(),
            "response_data": response_data
        }
        self.test_results.append(result)
        self.total_tests += 1
        if success:
            self.success_count += 1
            
        status = "‚úÖ PASS" if success else "‚ùå FAIL"
        print(f"{status} {test_name}: {details}")
        if response_data and not success:
            print(f"   Response: {response_data}")
    
    def test_thomas_v2_accueil_template(self):
        """Test 1: Message d'accueil selon template V2"""
        try:
            chat_data = {
                "message": "Bonjour",
                "session_id": "test_accueil_v2"
            }
            
            response = self.session.post(
                f"{BACKEND_URL}/ai-agents/chat",
                json=chat_data,
                headers={"Content-Type": "application/json"}
            )
            
            if response.status_code == 200:
                data = response.json()
                response_message = data.get("response", "").lower()
                
                # V√©rifier √©l√©ments template accueil V2
                v2_elements = [
                    "thomas" in response_message,
                    "conseiller" in response_message or "expert" in response_message,
                    "josmoze" in response_message or "josmose" in response_message,
                    "osmoseur" in response_message,
                    "famille" in response_message or "aider" in response_message
                ]
                
                success_rate = sum(v2_elements) / len(v2_elements)
                
                if success_rate >= 0.8:  # 80% des √©l√©ments pr√©sents
                    self.log_test("ACCUEIL V2 Template", True, 
                                f"‚úÖ Template V2 d√©tect√© ({success_rate*100:.0f}%): Thomas conseiller Josmoze pr√©sent")
                    return True
                else:
                    self.log_test("ACCUEIL V2 Template", False, 
                                f"‚ùå Template V2 incomplet ({success_rate*100:.0f}%): {response_message[:100]}...")
                    return False
            else:
                self.log_test("ACCUEIL V2 Template", False, f"Status: {response.status_code}", response.text)
                return False
        except Exception as e:
            self.log_test("ACCUEIL V2 Template", False, f"Exception: {str(e)}")
            return False

    def test_thomas_v2_prix_corrects(self):
        """Test 2: Prix corrects (449‚Ç¨, 549‚Ç¨, 899‚Ç¨, 39.90‚Ç¨)"""
        try:
            chat_data = {
                "message": "Quels sont vos prix ?",
                "session_id": "test_prix_v2"
            }
            
            response = self.session.post(
                f"{BACKEND_URL}/ai-agents/chat",
                json=chat_data,
                headers={"Content-Type": "application/json"}
            )
            
            if response.status_code == 200:
                data = response.json()
                response_message = data.get("response", "")
                
                # V√©rifier prix corrects V2
                prix_corrects = [
                    "449" in response_message and "‚Ç¨" in response_message,  # Essentiel 449‚Ç¨
                    "549" in response_message and "‚Ç¨" in response_message,  # Premium 549‚Ç¨
                    "899" in response_message and "‚Ç¨" in response_message,  # Prestige 899‚Ç¨
                    "39.90" in response_message or "39,90" in response_message  # Filtre Douche 39.90‚Ç¨
                ]
                
                prix_found = sum(prix_corrects)
                
                if prix_found >= 3:  # Au moins 3 prix corrects sur 4
                    self.log_test("PRIX CORRECTS V2", True, 
                                f"‚úÖ Prix V2 d√©tect√©s ({prix_found}/4): 449‚Ç¨, 549‚Ç¨, 899‚Ç¨, 39.90‚Ç¨")
                    return True
                else:
                    self.log_test("PRIX CORRECTS V2", False, 
                                f"‚ùå Prix V2 manquants ({prix_found}/4): {response_message[:200]}...")
                    return False
            else:
                self.log_test("PRIX CORRECTS V2", False, f"Status: {response.status_code}", response.text)
                return False
        except Exception as e:
            self.log_test("PRIX CORRECTS V2", False, f"Exception: {str(e)}")
            return False

    def test_thomas_v2_objection_budget_bienveillant(self):
        """Test 3: Objection budget avec ton bienveillant + Essentiel 449‚Ç¨"""
        try:
            chat_data = {
                "message": "C'est trop cher",
                "session_id": "test_budget_v2"
            }
            
            response = self.session.post(
                f"{BACKEND_URL}/ai-agents/chat",
                json=chat_data,
                headers={"Content-Type": "application/json"}
            )
            
            if response.status_code == 200:
                data = response.json()
                response_message = data.get("response", "").lower()
                
                # V√©rifier ton bienveillant V2
                ton_bienveillant = [
                    "comprends" in response_message or "compr√©hensible" in response_message,
                    "budget" in response_message,
                    "essentiel" in response_message,
                    "449" in response_message,
                    not any(word in response_message for word in ["urgent", "maintenant", "rapidement", "vite"])
                ]
                
                bienveillance_score = sum(ton_bienveillant) / len(ton_bienveillant)
                
                if bienveillance_score >= 0.8:
                    self.log_test("OBJECTION BUDGET Bienveillant", True, 
                                f"‚úÖ Ton bienveillant V2 ({bienveillance_score*100:.0f}%): Essentiel 449‚Ç¨ propos√©")
                    return True
                else:
                    self.log_test("OBJECTION BUDGET Bienveillant", False, 
                                f"‚ùå Ton insuffisamment bienveillant ({bienveillance_score*100:.0f}%): {response_message[:150]}...")
                    return False
            else:
                self.log_test("OBJECTION BUDGET Bienveillant", False, f"Status: {response.status_code}", response.text)
                return False
        except Exception as e:
            self.log_test("OBJECTION BUDGET Bienveillant", False, f"Exception: {str(e)}")
            return False

    def test_thomas_v2_premium_info_pitch(self):
        """Test 4: Info Premium 549‚Ç¨ avec thomas_pitch"""
        try:
            chat_data = {
                "message": "Parlez-moi du Premium",
                "session_id": "test_premium_v2"
            }
            
            response = self.session.post(
                f"{BACKEND_URL}/ai-agents/chat",
                json=chat_data,
                headers={"Content-Type": "application/json"}
            )
            
            if response.status_code == 200:
                data = response.json()
                response_message = data.get("response", "").lower()
                
                # V√©rifier info Premium V2 avec thomas_pitch
                premium_elements = [
                    "premium" in response_message,
                    "549" in response_message and "‚Ç¨" in response_message,
                    "bestseller" in response_message or "populaire" in response_message,
                    "familles" in response_message and ("4-5" in response_message or "4" in response_message),
                    "technologie" in response_message or "avanc√©e" in response_message
                ]
                
                premium_score = sum(premium_elements) / len(premium_elements)
                
                if premium_score >= 0.8:
                    self.log_test("PREMIUM INFO Thomas_Pitch", True, 
                                f"‚úÖ Premium V2 pitch complet ({premium_score*100:.0f}%): 549‚Ç¨ bestseller familles 4-5")
                    return True
                else:
                    self.log_test("PREMIUM INFO Thomas_Pitch", False, 
                                f"‚ùå Premium pitch incomplet ({premium_score*100:.0f}%): {response_message[:150]}...")
                    return False
            else:
                self.log_test("PREMIUM INFO Thomas_Pitch", False, f"Status: {response.status_code}", response.text)
                return False
        except Exception as e:
            self.log_test("PREMIUM INFO Thomas_Pitch", False, f"Exception: {str(e)}")
            return False

    def test_thomas_v2_filtre_douche_prix(self):
        """Test 5: Filtre douche 39.90‚Ç¨ correct"""
        try:
            chat_data = {
                "message": "Filtre douche",
                "session_id": "test_filtre_v2"
            }
            
            response = self.session.post(
                f"{BACKEND_URL}/ai-agents/chat",
                json=chat_data,
                headers={"Content-Type": "application/json"}
            )
            
            if response.status_code == 200:
                data = response.json()
                response_message = data.get("response", "")
                
                # V√©rifier filtre douche V2
                filtre_elements = [
                    "filtre" in response_message.lower() and "douche" in response_message.lower(),
                    "39.90" in response_message or "39,90" in response_message,
                    "‚Ç¨" in response_message,
                    "peau" in response_message.lower() or "cheveux" in response_message.lower(),
                    "bien-√™tre" in response_message.lower() or "compl√©ment" in response_message.lower()
                ]
                
                filtre_score = sum(filtre_elements) / len(filtre_elements)
                
                if filtre_score >= 0.8:
                    self.log_test("FILTRE DOUCHE Prix Correct", True, 
                                f"‚úÖ Filtre douche V2 complet ({filtre_score*100:.0f}%): 39.90‚Ç¨ bien-√™tre")
                    return True
                else:
                    self.log_test("FILTRE DOUCHE Prix Correct", False, 
                                f"‚ùå Filtre douche incomplet ({filtre_score*100:.0f}%): {response_message[:150]}...")
                    return False
            else:
                self.log_test("FILTRE DOUCHE Prix Correct", False, f"Status: {response.status_code}", response.text)
                return False
        except Exception as e:
            self.log_test("FILTRE DOUCHE Prix Correct", False, f"Exception: {str(e)}")
            return False

    def test_thomas_v2_response_templates_usage(self):
        """Test 6: Utilisation des response_templates V2"""
        try:
            # Test avec message g√©n√©rique pour v√©rifier templates
            chat_data = {
                "message": "Comment √ßa marche ?",
                "session_id": "test_templates_v2"
            }
            
            response = self.session.post(
                f"{BACKEND_URL}/ai-agents/chat",
                json=chat_data,
                headers={"Content-Type": "application/json"}
            )
            
            if response.status_code == 200:
                data = response.json()
                response_message = data.get("response", "").lower()
                suggestions = data.get("suggestions", [])
                
                # V√©rifier structure response_templates V2
                template_elements = [
                    "thomas" in response_message,
                    "expert" in response_message or "conseiller" in response_message,
                    "josmoze" in response_message or "josmose" in response_message,
                    len(suggestions) >= 2,  # Suggestions pr√©sentes
                    "osmoseur" in response_message
                ]
                
                template_score = sum(template_elements) / len(template_elements)
                
                if template_score >= 0.8:
                    self.log_test("RESPONSE TEMPLATES V2 Usage", True, 
                                f"‚úÖ Templates V2 utilis√©s ({template_score*100:.0f}%): Structure professionnelle")
                    return True
                else:
                    self.log_test("RESPONSE TEMPLATES V2 Usage", False, 
                                f"‚ùå Templates V2 insuffisants ({template_score*100:.0f}%): {response_message[:100]}...")
                    return False
            else:
                self.log_test("RESPONSE TEMPLATES V2 Usage", False, f"Status: {response.status_code}", response.text)
                return False
        except Exception as e:
            self.log_test("RESPONSE TEMPLATES V2 Usage", False, f"Exception: {str(e)}")
            return False

    def run_thomas_v2_sync_validation(self):
        """Ex√©cute tous les tests de synchronisation Thomas V2"""
        print("ü§ñ D√âMARRAGE VALIDATION THOMAS V2 SYNCHRONISATION BACKEND-FRONTEND")
        print("=" * 70)
        
        # Tests de synchronisation V2
        tests = [
            self.test_thomas_v2_accueil_template,
            self.test_thomas_v2_prix_corrects,
            self.test_thomas_v2_objection_budget_bienveillant,
            self.test_thomas_v2_premium_info_pitch,
            self.test_thomas_v2_filtre_douche_prix,
            self.test_thomas_v2_response_templates_usage
        ]
        
        for test in tests:
            try:
                test()
                time.sleep(0.5)  # Pause entre tests
            except Exception as e:
                print(f"‚ùå ERREUR TEST {test.__name__}: {str(e)}")
        
        # Calcul du taux de r√©ussite
        success_rate = (self.success_count / self.total_tests) * 100 if self.total_tests > 0 else 0
        
        print("\n" + "=" * 70)
        print(f"üéØ R√âSULTATS VALIDATION THOMAS V2 SYNCHRONISATION")
        print(f"üìä Taux de r√©ussite: {success_rate:.1f}% ({self.success_count}/{self.total_tests})")
        
        if success_rate >= 80:
            print("‚úÖ SYNCHRONISATION THOMAS V2 VALID√âE - Objectif 80%+ atteint!")
            validation_status = "SUCCESS"
        else:
            print("‚ùå SYNCHRONISATION THOMAS V2 √âCHOU√âE - Objectif 80%+ non atteint")
            validation_status = "FAILED"
        
        print("\nüìã D√âTAIL DES TESTS:")
        for result in self.test_results:
            status = "‚úÖ" if result["success"] else "‚ùå"
            print(f"{status} {result['test']}: {result['details']}")
        
        return {
            "validation_status": validation_status,
            "success_rate": success_rate,
            "tests_passed": self.success_count,
            "total_tests": self.total_tests,
            "detailed_results": self.test_results
        }

def main():
    """Point d'entr√©e principal"""
    tester = ThomasV2SyncTester()
    results = tester.run_thomas_v2_sync_validation()
    
    # Retourner le code de sortie appropri√©
    return 0 if results["validation_status"] == "SUCCESS" else 1

if __name__ == "__main__":
    exit(main())