import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import LanguageDetector from 'i18next-browser-languagedetector';
import Backend from 'i18next-http-backend';

const backendUrl = process.env.REACT_APP_BACKEND_URL || 'http://localhost:8001';

// Configuration des langues disponibles - utiliser des codes compatibles i18next
const supportedLanguages = ['FR', 'EN', 'ES', 'IT', 'DE', 'NL', 'PT', 'PL'];

// Map DeepL language codes to i18next language codes
const deepLToI18nMap = {
  'FR': 'FR',
  'EN-US': 'EN', 
  'EN-GB': 'EN',
  'ES': 'ES',
  'IT': 'IT',
  'DE': 'DE',
  'NL': 'NL',
  'PT-PT': 'PT',
  'PL': 'PL'
};

// Map inverse pour l'affichage
const i18nToDeepLMap = {
  'FR': 'FR',
  'EN': 'EN-GB', // Par d√©faut britannique pour l'Europe
  'ES': 'ES',
  'IT': 'IT', 
  'DE': 'DE',
  'NL': 'NL',
  'PT': 'PT-PT',
  'PL': 'PL'
};

// Ressources de traduction par d√©faut (fallback)
const resources = {
  'FR': {
    translation: {
      // Navigation
      'nav.home': 'Accueil',
      'nav.individuals': 'Particuliers', 
      'nav.professionals': 'Professionnels',
      'nav.installation': 'Installation',
      'nav.contact': 'Contact',
      'nav.cart': 'Panier',
      
      // Hero section - B2C
      'hero.title.b2c': 'Eau Pure avec Syst√®me d\'Osmose Inverse',
      'hero.subtitle.b2c': '√âliminez 99% des contaminants avec notre technologie avanc√©e',
      'hero.title.b2b': 'Solutions Professionnelles d\'Osmose Inverse',
      'hero.subtitle.b2b': '√âquipez votre entreprise avec nos syst√®mes industriels',
      'hero.special_price': 'Prix sp√©cial Europe',
      'hero.original_price': 'Prix normal',
      'hero.cta': 'Commander Maintenant',
      'hero.guarantee': '‚úì Garantie 2 ans ‚úì Installation incluse ‚úì SAV France',
      
      // Contaminants section
      'contaminants.title': 'Contaminants √©limin√©s',
      'contaminants.chlore': 'Chlore',
      'contaminants.plomb': 'Plomb',
      'contaminants.pesticides': 'Pesticides',
      'contaminants.nitrates': 'Nitrates',
      'contaminants.virus': 'Virus & Bact√©ries',
      'contaminants.metaux': 'M√©taux lourds',
      
      // Products section
      'products.title.b2c': 'Nos Produits üíß',
      'products.title.b2b': 'Solutions Professionnelles üíº',
      'products.subtitle.b2c': 'Syst√®mes d\'osmose inverse pour votre foyer',
      'products.subtitle.b2b': 'Syst√®mes industriels pour restaurants, bureaux et commerces',
      'products.addToCart.b2c': 'Ajouter au Panier üõí',
      'products.addToCart.b2b': 'Demander un Devis üìã',
      'products.outOfStock': 'Indisponible',
      'products.inStock': '‚úÖ En stock',
      'products.outOfStockStatus': '‚ùå Rupture',
      'products.stockLimited': '‚ö†Ô∏è Stock limit√© !',
      'products.professionalPrice': 'Prix Professionnel HT',
      'products.professionalBadge': 'Solution Pro',
      
      // Customer type selector
      'customer.individuals': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Particuliers',
      'customer.professionals': 'üè¢ Professionnels',
      
      // Cart
      'cart.title': 'Votre Panier üõí',
      'cart.empty': 'Votre panier est vide',
      'cart.emptySubtitle': 'D√©couvrez nos syst√®mes d\'osmose inverse',
      'cart.viewProducts': 'Voir nos produits',
      'cart.summary': 'R√©capitulatif',
      'cart.subtotal': 'Sous-total:',
      'cart.shipping': 'Livraison:',
      'cart.total': 'Total:',
      'cart.checkout': 'Proc√©der au Paiement üí≥',
      'cart.continueShop': 'Continuer mes achats',
      
      // Contact & Consultation
      'consultation.title': 'Consultation Gratuite avec un Expert üìû',
      'consultation.subtitle': 'Obtenez un diagnostic complet et une solution adapt√©e √† vos besoins professionnels',
      'consultation.success.title': 'Consultation Programm√©e!',
      'consultation.success.subtitle': 'Un expert vous contactera dans les prochaines heures pour programmer votre consultation gratuite.',
      'consultation.whatYouGet': 'Ce que vous obtiendrez :',
      'consultation.experts': 'üèÜ Nos Experts',
      'consultation.expertsDesc': 'Ing√©nieurs sp√©cialis√©s avec +10 ans d\'exp√©rience dans le traitement de l\'eau industriel. Certifications ISO et formations techniques continues.',
      
      // Form fields
      'form.name': 'Nom complet',
      'form.email': 'Email',
      'form.phone': 'T√©l√©phone',
      'form.company': 'Entreprise',
      'form.message': 'Message',
      'form.send': 'Envoyer',
      'form.required': 'obligatoire',
      'form.success': 'Message Envoy√©!',
      
      // Footer
      'footer.about': '√Ä propos de Josmose',
      'footer.contact': 'Contact',
      'footer.legal': 'Mentions L√©gales',
      'footer.privacy': 'Confidentialit√©',
      
      // Localization
      'language.selector': 'Choisir la langue',
      'currency.symbol': '‚Ç¨',
      'shipping.cost': 'Frais de port'
    }
  },
  'EN': {
    translation: {
      // Navigation  
      'nav.home': 'Home',
      'nav.individuals': 'Individuals',
      'nav.professionals': 'Professionals', 
      'nav.installation': 'Installation',
      'nav.contact': 'Contact',
      'nav.cart': 'Cart',
      
      // Hero section
      'hero.title.b2c': 'Pure Water with Reverse Osmosis System',
      'hero.subtitle.b2c': 'Remove 99% of contaminants with our advanced technology',
      'hero.title.b2b': 'Professional Reverse Osmosis Solutions',
      'hero.subtitle.b2b': 'Equip your business with our industrial systems',
      'hero.special_price': 'Special European price',
      'hero.original_price': 'Normal price',
      'hero.cta': 'Order Now',
      'hero.guarantee': '‚úì 2-year warranty ‚úì Installation included ‚úì UK support',
      
      // Contaminants section
      'contaminants.title': 'Contaminants removed',
      'contaminants.chlore': 'Chlorine',
      'contaminants.plomb': 'Lead',
      'contaminants.pesticides': 'Pesticides',
      'contaminants.nitrates': 'Nitrates',
      'contaminants.virus': 'Viruses & Bacteria',
      'contaminants.metaux': 'Heavy metals',
      
      // Products
      'products.title.b2c': 'Our Products üíß',
      'products.title.b2b': 'Professional Solutions üíº',
      'products.subtitle.b2c': 'Reverse osmosis systems for your home',
      'products.subtitle.b2b': 'Industrial systems for restaurants, offices and businesses',
      'products.addToCart.b2c': 'Add to Cart üõí',
      'products.addToCart.b2b': 'Request Quote üìã',
      'products.outOfStock': 'Unavailable',
      'products.inStock': '‚úÖ In stock',
      'products.outOfStockStatus': '‚ùå Out of stock',
      'products.stockLimited': '‚ö†Ô∏è Limited stock!',
      'products.professionalPrice': 'Professional Price excl. VAT',
      'products.professionalBadge': 'Pro Solution',
      
      // Customer type
      'customer.individuals': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Individuals',
      'customer.professionals': 'üè¢ Professionals',
      
      // Cart
      'cart.title': 'Your Cart üõí',
      'cart.empty': 'Your cart is empty',
      'cart.emptySubtitle': 'Discover our reverse osmosis systems',
      'cart.viewProducts': 'View our products',
      'cart.summary': 'Summary',
      'cart.subtotal': 'Subtotal:',
      'cart.shipping': 'Shipping:',
      'cart.total': 'Total:',
      'cart.checkout': 'Proceed to Payment üí≥',
      'cart.continueShop': 'Continue shopping',
      
      // Contact & Consultation
      'consultation.title': 'Free Expert Consultation üìû',
      'consultation.subtitle': 'Get a complete diagnosis and solution adapted to your professional needs',
      'consultation.success.title': 'Consultation Scheduled!',
      'consultation.success.subtitle': 'An expert will contact you within the next few hours to schedule your free consultation.',
      'consultation.whatYouGet': 'What you will get:',
      'consultation.experts': 'üèÜ Our Experts',
      'consultation.expertsDesc': 'Specialized engineers with 10+ years experience in industrial water treatment. ISO certifications and continuous technical training.',
      
      // Form fields
      'form.name': 'Full name',
      'form.email': 'Email',
      'form.phone': 'Phone',
      'form.company': 'Company',
      'form.message': 'Message',
      'form.send': 'Send',
      'form.required': 'required',
      'form.success': 'Message Sent!',
      
      // Footer
      'footer.about': 'About Josmose',
      'footer.contact': 'Contact',
      'footer.legal': 'Legal Notice',
      'footer.privacy': 'Privacy',
      
      // Localization
      'language.selector': 'Choose language',
      'currency.symbol': '¬£',
      'shipping.cost': 'Shipping cost'
    }
  },
  'ES': {
    translation: {
      // Navigation
      'nav.home': 'Inicio',
      'nav.individuals': 'Particulares',
      'nav.professionals': 'Profesionales',
      'nav.installation': 'Instalaci√≥n',
      'nav.contact': 'Contacto',
      'nav.cart': 'Carrito',
      
      // Hero section
      'hero.title.b2c': 'Agua Pura con Sistema de √ìsmosis Inversa',
      'hero.subtitle.b2c': 'Elimina el 99% de los contaminantes con nuestra tecnolog√≠a avanzada',
      'hero.title.b2b': 'Soluciones Profesionales de √ìsmosis Inversa',
      'hero.subtitle.b2b': 'Equipe su empresa con nuestros sistemas industriales',
      'hero.special_price': 'Precio especial Europa',
      'hero.original_price': 'Precio normal',
      'hero.cta': 'Pedir Ahora',
      'hero.guarantee': '‚úì Garant√≠a 2 a√±os ‚úì Instalaci√≥n incluida ‚úì Soporte Espa√±a',
      
      // Contaminants
      'contaminants.title': 'Contaminantes eliminados',
      'contaminants.chlore': 'Cloro',
      'contaminants.plomb': 'Plomo',
      'contaminants.pesticides': 'Pesticidas',
      'contaminants.nitrates': 'Nitratos',
      'contaminants.virus': 'Virus y Bacterias',
      'contaminants.metaux': 'Metales pesados',
      
      // Products
      'products.title.b2c': 'Nuestros Productos üíß',
      'products.title.b2b': 'Soluciones Profesionales üíº',
      'products.subtitle.b2c': 'Sistemas de √≥smosis inversa para su hogar',
      'products.subtitle.b2b': 'Sistemas industriales para restaurantes, oficinas y comercios',
      'products.addToCart.b2c': 'A√±adir al Carrito üõí',
      'products.addToCart.b2b': 'Solicitar Presupuesto üìã',
      'products.outOfStock': 'No disponible',
      'products.inStock': '‚úÖ En stock',
      'products.outOfStockStatus': '‚ùå Sin stock',
      'products.stockLimited': '‚ö†Ô∏è ¬°Stock limitado!',
      'products.professionalPrice': 'Precio Profesional sin IVA',
      'products.professionalBadge': 'Soluci√≥n Pro',
      
      'customer.individuals': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Particulares',
      'customer.professionals': 'üè¢ Profesionales',
      
      'currency.symbol': '‚Ç¨',
      'shipping.cost': 'Gastos de env√≠o'
    }
  },
  'DE': {
    translation: {
      // Navigation
      'nav.home': 'Startseite',
      'nav.individuals': 'Privatkunden',
      'nav.professionals': 'Gesch√§ftskunden', 
      'nav.installation': 'Installation',
      'nav.contact': 'Kontakt',
      'nav.cart': 'Warenkorb',
      
      // Hero section
      'hero.title.b2c': 'Reines Wasser mit Umkehrosmose-System',
      'hero.subtitle.b2c': 'Beseitigen Sie 99% der Schadstoffe mit unserer fortschrittlichen Technologie',
      'hero.title.b2b': 'Professionelle Umkehrosmose-L√∂sungen',
      'hero.subtitle.b2b': 'Statten Sie Ihr Unternehmen mit unseren Industriesystemen aus',
      'hero.special_price': 'Europa Sonderpreis',
      'hero.original_price': 'Normalpreis',
      'hero.cta': 'Jetzt bestellen',
      'hero.guarantee': '‚úì 2 Jahre Garantie ‚úì Installation inklusive ‚úì Deutschland Support',
      
      'currency.symbol': '‚Ç¨',
      'shipping.cost': 'Versandkosten'
    }
  }
};

// Configuration i18next
i18n
  .use(Backend)
  .use(LanguageDetector)
  .use(initReactI18next)
  .init({
    lng: 'FR', // langue par d√©faut
    fallbackLng: 'FR',
    
    supportedLngs: supportedLanguages,
    
    debug: process.env.NODE_ENV === 'development',
    
    detection: {
      // Options de d√©tection de langue
      order: ['localStorage', 'navigator', 'htmlTag'],
      caches: ['localStorage'],
      excludeCacheFor: ['cimode'],
      lookupLocalStorage: 'i18nextLng'
    },
    
    backend: {
      // Configuration pour charger les traductions depuis notre API
      loadPath: `${backendUrl}/api/localization/translate-bulk`,
      addPath: `${backendUrl}/api/localization/translate`,
      allowMultiLoading: false,
      crossDomain: true,
      
      // Custom request function pour utiliser notre API
      request: (options, url, payload, callback) => {
        // Si on charge les traductions par d√©faut, utiliser les ressources locales
        if (url.includes('/localization/')) {
          const lng = options.lng || 'FR';
          const namespace = options.ns || 'translation';
          
          if (resources[lng] && resources[lng][namespace]) {
            callback(null, {
              status: 200,
              data: resources[lng][namespace]
            });
          } else {
            callback(null, {
              status: 404,
              data: {}
            });
          }
        } else {
          callback(new Error('Translation backend not available'), {
            status: 404,
            data: {}
          });
        }
      }
    },
    
    resources: resources,
    
    interpolation: {
      escapeValue: false, // React est d√©j√† s√©curis√©
      format: function(value, format, lng) {
        if (format === 'currency') {
          // Formatage de devise selon la langue
          const currencyMap = {
            'FR': '‚Ç¨',
            'EN-GB': '¬£',
            'EN-US': '$',
            'ES': '‚Ç¨',
            'IT': '‚Ç¨', 
            'DE': '‚Ç¨',
            'NL': '‚Ç¨',
            'PT-PT': '‚Ç¨',
            'PL': 'z≈Ç'
          };
          
          const symbol = currencyMap[lng] || '‚Ç¨';
          return `${value}${symbol}`;
        }
        return value;
      }
    },
    
    react: {
      useSuspense: false,
      bindI18n: 'languageChanged loaded',
      bindI18nStore: 'added removed',
      transEmptyNodeValue: '',
      transSupportBasicHtmlNodes: true,
      transKeepBasicHtmlNodesFor: ['br', 'strong', 'i', 'p']
    }
  });

// Fonctions utilitaires pour la conversion des codes de langue
export const convertDeepLToI18n = (deepLCode) => {
  return deepLToI18nMap[deepLCode] || 'FR';
};

export const convertI18nToDeepL = (i18nCode) => {
  return i18nToDeepLMap[i18nCode] || 'FR';
};

export const getAvailableLanguagesForDisplay = () => {
  return {
    'FR': { name: 'Fran√ßais', native_name: 'Fran√ßais', flag: 'üá´üá∑', deepl_code: 'FR' },
    'EN': { name: 'English', native_name: 'English', flag: 'üá¨üáß', deepl_code: 'EN-GB' },
    'ES': { name: 'Espa√±ol', native_name: 'Espa√±ol', flag: 'üá™üá∏', deepl_code: 'ES' },
    'IT': { name: 'Italiano', native_name: 'Italiano', flag: 'üáÆüáπ', deepl_code: 'IT' },
    'DE': { name: 'Deutsch', native_name: 'Deutsch', flag: 'üá©üá™', deepl_code: 'DE' },
    'NL': { name: 'Nederlands', native_name: 'Nederlands', flag: 'üá≥üá±', deepl_code: 'NL' },
    'PT': { name: 'Portugu√™s', native_name: 'Portugu√™s', flag: 'üáµüáπ', deepl_code: 'PT-PT' },
    'PL': { name: 'Polski', native_name: 'Polski', flag: 'üáµüá±', deepl_code: 'PL' }
  };
};

export default i18n;